# CPU Fragment

## Overview

An implementation of a multi-threaded "fragment" renderer, where the fragment shaders are written in `c`. Renders the shaders on the CPU.


## Use

The easiest way to use this is to make use of a template. The templates provide all the required functionality except for the fragment code itself. All templates can be generated by running `make` in the root directory.

A fragment shader can be compiled alongside a template using the `shaderc` bash script provided, by calling `./shaderc <fragment source> <template shared object>`.

Note that code provided to `shaderc` does not have to include any fragment related headers.


### `plain_frag_template`

The simplest template, this provides the template for a shader program that;
- Takes as input: the path to save files at (minus the file extension), the x and y resolution to render at, and the number of frames (optional, defaults to `1`)
- Saves the resulting frame(s) to a `png` file

A user provided file should do the following;
- Provide a function `fragment(tup3 *frag_coord) -> tup3 frag_colour` (see below for a description of the `fragment` function)


### `png_io_template`

A template that loads a `png` file to do work on. The loaded file will also be provided as the initial `BACKBUF`.

Results in a shader program that;
- Takes as input: the `png` file to load, the path to save files at (minus the file extension), and the number of frames (optional, defaults to `1`)
- Saves the resulting frame(s) ot a `png` file

A user provided file should do the following;
- Provide a function `fragment(tup3 *frag_coord) -> tup3 frag_colour` (see below for a description of the `fragment` function)


## `fragment`

The `fragment` function provides the per-pixel functionality of the shader. All code used in the `fragment` function must be threadsafe.

As input, it receives a pointer to a single `tup3`, with the `x` and `y` components to the coordinates of the current pixel. The `z` and `w` components are not defined and should not be used.

As output, it should return a single `tup3`, with the `x`, `y` and `z` components set to the `r`, `g`, `b` colour channels of that pixel (ranging from `0.0` to `1.0`).

The fragment shader also automatically has access to the following uniform values. Uniforms should only ever be read from (writing to them is undefined).

- `framebuf *BACKBUF` - the previously rendered frame (defaults to all black for frame `0`). Should only be interacted with through the `int framebuf_read(framebuf *fb, unsigned int x, unsigned int y, tup3 *dest)` function, which reads the pixel from the given coordinates into the provided destination.
- `unsigned long FRAME_COUNT` - the frame number, starting from `0`
- `tup3 FRAME_DIM` - the dimensions of the frames being rendered (in `x` and `y` components). The `z` and `w` components are undefined.
- `float CONST_RAND` - a constant random value, seeded with the time at which the shader was initially ran. Is constant between frames (ie. for an entire execution).
